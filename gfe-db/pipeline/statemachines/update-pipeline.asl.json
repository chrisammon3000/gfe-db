{
    "StartAt": "Pre-Execution Validation Query",
    "States": {
        "Pre-Execution Validation Query": {
            "Type": "Task",
            "Resource": "${ExecuteValidationQueriesFunctionArn}",
            "ResultPath": "$.validations.queries.pre",
            "Next": "Pre-Execution Backup"
        },
        "Pre-Execution Backup": {
            "Type": "Task",
            "Resource": "${InvokeBackupScriptFunctionArn}",
            "ResultPath": "$.backups.pre",
            "Next": "GetExecutionState"
        },
        "GetExecutionState": {
            "Type": "Task",
            "Resource": "${GetExecutionStateFunctionArn}",
            "ResultPath": "$.state",
            "Next": "GfeDbBuildJob"
        },
        "GfeDbBuildJob": {
            "Type": "Task",
            "Resource": "arn:aws:states:::batch:submitJob.sync",
            "ResultPath": null,
            "Next": "Validate Build",
            "Parameters": {
                "JobDefinition": "${BuildJobDefinition}",
                "JobName": "${BuildJobName}",
                "JobQueue": "${BuildJobQueue}",
                "ContainerOverrides": {
                    "Environment": [
                        {
                            "Name": "EVENT",
                            "Value.$": "States.JsonToString($)"
                        }
                    ]
                }
            }
        },
        "Validate Build": {
            "Type": "Task",
            "Resource": "${ValidateBuildOutputFunctionArn}",
            "Parameters": {
                "execution_context.$": "$$"
            },
            "ResultPath": "$.validations.build",
            "Next": "Evaluate Payload"
        },
        "Evaluate Payload": {
            "Type": "Choice",
            "Choices": [
                {
                    "Variable": "$.validations.build.has_valid_payload",
                    "BooleanEquals": true,
                    "Next": "Load Stage"
                }
            ],
            "Default": "Execution Failed"
        },
        "Execution Failed": {
            "Type": "Fail",
            "Error": "ExecutionFailed",
            "Cause": "No valid payload was generated"
        },
        "Load Stage": {
            "Type": "Parallel",
            "OutputPath": "$.[1]",
            "ResultPath": null,
            "Next": "Post-Execution Validation Query",
            "Branches": [
                {
                    "StartAt": "InvokeLoadScript",
                    "States": {
                        "InvokeLoadScript": {
                            "Type": "Task",
                            "Resource": "${InvokeLoadScriptFunctionArn}",
                            "End": true
                        }
                    }
                },
                {
                    "StartAt": "LoadReleaseActivity",
                    "States": {
                        "LoadReleaseActivity": {
                            "Type": "Task",
                            "Resource": "${LoadReleaseActivityArn}",
                            "HeartbeatSeconds": 60,
                            "End": true
                        }
                    }
                }
            ]
        },
        "Post-Execution Validation Query": {
            "Type": "Task",
            "Resource": "${ExecuteValidationQueriesFunctionArn}",
            "ResultPath": "$.validations.queries.post",
            "Next": "Post-Execution Backup"
        },
        "Post-Execution Backup": {
            "Type": "Task",
            "Resource": "${InvokeBackupScriptFunctionArn}",
            "ResultPath": "$.backups.post",
            "End": true
        }
    }
}